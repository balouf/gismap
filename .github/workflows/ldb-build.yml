name: Build LDB Database

on:
  schedule:
    - cron: '0 2 * * 0'  # Weekly on Sunday 2 AM UTC
  workflow_dispatch:  # Manual trigger

jobs:
  build-ldb:
    name: Build and Upload LDB Database
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Build takes ~30 min, allow margin
    permissions:
      contents: write  # To upload release assets

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "0.9.27"

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Build LDB database
        run: |
          echo "Building LDB database from DBLP TTL..."
          uv run python -m gismap.build
          echo "Build complete."

      - name: Locate and verify database
        id: locate-db
        run: |
          # Find database in platformdirs location
          DB_PATH=$(uv run python -c "from gismap.sources.ldb import LDB_PATH; print(LDB_PATH)")
          echo "Database path: $DB_PATH"

          if [ ! -f "$DB_PATH" ]; then
            echo "ERROR: Database not found at $DB_PATH"
            exit 1
          fi

          # Get file size
          DB_SIZE=$(stat -c%s "$DB_PATH")
          echo "Database size: $DB_SIZE bytes ($(echo "scale=2; $DB_SIZE / 1073741824" | bc) GB)"

          # Get counts
          AUTHOR_COUNT=$(uv run python -c "from gismap.sources.ldb import LDB; LDB.load_db(); print(len(LDB.authors))")
          PUBLI_COUNT=$(uv run python -c "from gismap.sources.ldb import LDB; LDB.load_db(); print(len(LDB.publis))")
          echo "Authors: $AUTHOR_COUNT, Publications: $PUBLI_COUNT"

          echo "db_path=$DB_PATH" >> $GITHUB_OUTPUT
          echo "db_size=$DB_SIZE" >> $GITHUB_OUTPUT
          echo "author_count=$AUTHOR_COUNT" >> $GITHUB_OUTPUT
          echo "publi_count=$PUBLI_COUNT" >> $GITHUB_OUTPUT

      - name: Find latest release
        id: latest-release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LATEST_TAG=$(gh release list --limit 1 --json tagName -q '.[0].tagName')
          if [ -z "$LATEST_TAG" ]; then
            echo "ERROR: No releases found"
            exit 1
          fi
          echo "Latest release: $LATEST_TAG"
          echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: Upload LDB to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Uploading ldb.pkl.zst to release ${{ steps.latest-release.outputs.tag }}..."
          gh release upload "${{ steps.latest-release.outputs.tag }}" \
            "${{ steps.locate-db.outputs.db_path }}" \
            --clobber
          echo "Upload complete!"

      - name: Summary
        run: |
          echo "## LDB Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Release | ${{ steps.latest-release.outputs.tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Authors | ${{ steps.locate-db.outputs.author_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Publications | ${{ steps.locate-db.outputs.publi_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Database Size | $(echo "scale=2; ${{ steps.locate-db.outputs.db_size }} / 1073741824" | bc) GB |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Date | $(date -u +%Y-%m-%dT%H:%M:%SZ) |" >> $GITHUB_STEP_SUMMARY
